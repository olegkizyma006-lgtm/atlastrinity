# =============================================================================
# AtlasTrinity Behavior Configuration
# =============================================================================
# IMPORTANT: This is a TEMPLATE file. 
# After modifying this file, ensure the same changes are reflected in 
# the active config at ~/.config/atlastrinity/behavior_config.yaml.
# Conversely, if you modify the active config, update this template.
# =============================================================================
#
# Version: 1.1.0 (Atlas Focus Fix)
# Last Updated: 2026-01-23
# =============================================================================

# =============================================================================
# ADAPTIVE BEHAVIOR PATTERNS
# =============================================================================
# Learned patterns for non-standard decision-making
# Previously hardcoded in: adaptive_behavior.py (_register_default_patterns)
# =============================================================================

patterns:
  adaptive_behavior:
    web_task_fallback:
      description: 'Fallback to macOS browser automation when web tasks fail repeatedly'
      trigger:
        conditions:
          task_type: web
          repeated_failures: true
        min_confidence: 0.6
      action:
        server: macos-use
        tool: macos-use_fetch_url
        fallback_strategy: browser_automation
      metadata:
        initial_confidence: 0.6
        success_threshold: 0.8
        usage_priority: high

    gui_vision_assist:
      description: 'Use OCR and vision when accessibility tree fails for GUI tasks'
      trigger:
        conditions:
          task_type: gui
          accessibility_failed: true
        min_confidence: 0.7
      action:
        requires_vision: true
        use_ocr: true
        server: macos-use
        tool: macos-use_analyze_screen
      metadata:
        initial_confidence: 0.7
        success_threshold: 0.8
        usage_priority: medium

    permission_escalation:
      description: 'Retry with sudo when permission errors occur'
      trigger:
        conditions:
          error_contains: 'permission denied'
        min_confidence: 0.5
      action:
        retry_with_sudo: true
        confirm_required: true
        server: macos-use
        tool: execute_command
      metadata:
        initial_confidence: 0.5
        success_threshold: 0.7
        usage_priority: medium

# =============================================================================
# INTENT DETECTION & CLASSIFICATION
# =============================================================================
# User request intent classification patterns
# Previously hardcoded in: atlas.py (lines 263-315)
# =============================================================================

intent_detection:
  # Simple conversational greetings
  simple_chat:
    keywords:
      - привіт
      - хай
      - hello
      - hi
      - атлас
      - atlas
      - дякую
      - окей
      - ок
      - 'як справи'
      - 'як твої справи'
    max_words: 6
    intent: chat
    priority: high
    use_deep_persona: false

  # Information queries requiring tool usage
  info_query:
    keywords:
      - погода
      - weather
      - прогноз
      - температура
      - новини
      - news
      - ціна
      - price
      - курс
      - 'який час'
      - 'what time'
      - скільки
      - системн
      - версія
      - version
      - файл
      - file
      - знайди
      - find
      - пошук
      - search
      - покажи
      - шукай
      - 'розкажи про'
      - прочитай
    intent: solo_task
    require_tools: true
    priority: medium
    use_deep_persona: false

  # Complex tasks requiring planning
  complex_task:
    indicators:
      min_words: 7
      contains_action_verbs:
        - як
        - чому
        - виправ
        - зроби
        - поясни
        - how
        - why
        - fix
        - explain
        - create
        - створи
    intent: task
    require_planning: true
    use_deep_persona: true
    enable_sequential_thinking: true
    priority: high

  # Repeat/redo commands
  repeat_intent:
    keywords:
      - повтор
      - repeat
      - redo
      - 'останнє завдання'
      - 'last task'
      - 'з самого початку'
    intent: task
    resolve_from_memory: true
    priority: high

# =============================================================================
# TOOL ROUTING CONFIGURATION
# =============================================================================
# Server and tool resolution logic
# Previously hardcoded in: tool_dispatcher.py (lines 21-800)
# =============================================================================

tool_routing:
  # Terminal/Command execution
  terminal:
    synonyms:
      - terminal
      - bash
      - zsh
      - sh
      - python
      - python3
      - pip
      - pip3
      - cmd
      - run
      - execute
      - execute_command
      - terminal_execute
      - execute_terminal
      - terminal.execute
      - osascript
      - applescript
      - curl
      - wget
      - jq
      - grep
      - git
      - npm
      - npx
      - brew
      - mkdir
      - ls
      - cat
      - rm
      - mv
      - cp
      - touch
      - sudo
    priority_server: macos-use
    fallback_server: null
    tool_mapping:
      terminal: execute_command
      execute: execute_command
      run: execute_command
    routing_rules:
      - pattern: 'git.*'
        server: macos-use
        tool: execute_command
      - pattern: 'npm.*'
        server: macos-use
        tool: execute_command
      - pattern: 'curl.*'
        server: macos-use
        tool: macos-use_fetch_url

  # Filesystem operations
  filesystem:
    synonyms:
      - filesystem
      - fs
      - file
      - files
      - editor
      - directory_tree
      - list_directory
      - read_file
      - write_file
      - tree
    priority_server: filesystem
    fallback_server: macos-use
    tool_mapping:
      filesystem: read_file
      fs: read_file
      file: read_file
    routing_rules:
      - pattern: 'read.*'
        server: filesystem
        tool: read_file
      - pattern: 'write.*'
        server: filesystem
        tool: write_file

  # Browser/Web automation
  browser:
    synonyms:
      - browser
      - puppeteer
      - navigate
      - google
      - bing
      - web
      - web_search
      - internet_search
      - online_search
    priority_server: puppeteer
    fallback_server: macos-use
    tool_mapping:
      browser: puppeteer_navigate
      puppeteer: puppeteer_navigate
    routing_rules:
      - pattern: 'navigate.*'
        server: puppeteer
        tool: puppeteer_navigate
      - pattern: 'search.*'
        server: duckduckgo-search
        tool: duckduckgo_search

  # Search engines
  search:
    synonyms:
      - duckduckgo
      - ddg
      - duckduckgo-search
      - duckduckgo_search
      - search_web
      - web_search
    priority_server: duckduckgo-search
    fallback_server: puppeteer
    special_routing:
      business_registry:
        keywords: [єдрпоу, company, registry, youcontrol, opendatabot, бізнес, підприємство]
        server: duckduckgo-search
        tool: business_registry_search
      open_data:
        keywords: [dataset, датасет, data.gov.ua, портал, 'відкриті дані']
        server: duckduckgo-search
        tool: open_data_search

  # Code assistance (Vibe)
  vibe:
    synonyms:
      - vibe
      - vibe_prompt
      - vibe_ask
      - vibe_analyze_error
      - vibe_smart_plan
      - vibe_code_review
      - vibe_implement_feature
      - vibe_execute_subcommand
      - vibe_list_sessions
      - vibe_session_details
      - vibe_which
      - vibe_get_config
      - vibe_configure_model
      - vibe_set_mode
      - vibe_configure_provider
      - vibe_session_resume
      - vibe_reload_config
      - debug
      - fix
      - implement
      - feature
      - review
      - plan
      - ask
      - question
      - config
      - model
      - provider
      - resume
      - reload
      - mode
    priority_server: vibe
    fallback_server: null
    tool_mapping:
      vibe: vibe_prompt
      debug: vibe_analyze_error
      fix: vibe_analyze_error
      implement: vibe_implement_feature
      review: vibe_code_review
      plan: vibe_smart_plan
      ask: vibe_ask

  # Memory/Knowledge graph
  memory:
    synonyms:
      - memory
      - knowledge
      - entity
      - entities
      - observation
      - observations
      - fact
      - recall
      - remember
      - store_fact
      - add_memory
      - relationship
      - relation
    priority_server: memory
    fallback_server: null
    routing_rules:
      - pattern: 'search.*'
        server: memory
        tool: search
      - pattern: '.*entities.*'
        server: memory
        tool: create_entities
      - pattern: '.*observations.*'
        server: memory
        tool: add_observations

  # GitHub integration
  github:
    synonyms:
      - github
      - repo
      - repository
      - pull_request
      - pr
      - issue
      - issues
      - gh
      - git_hub
    priority_server: github
    fallback_server: null
    routing_rules:
      - pattern: 'repo_.*'
        server: github
      - pattern: 'issue_.*'
        server: github
      - pattern: 'pr_.*'
        server: github

  # Development tools
  devtools:
    synonyms:
      - devtools
      - lint
      - linter
      - check
      - inspect
      - inspector
      - validate
      - health
      - ruff
      - oxlint
      - knip
      - pyrefly
    priority_server: devtools
    fallback_server: null
    tool_mapping:
      lint: devtools_lint_python
      linter: devtools_lint_python
      ruff: devtools_lint_python
      oxlint: devtools_lint_js
      js_lint: devtools_lint_js
      inspect: devtools_launch_inspector
      inspector: devtools_launch_inspector
      health: devtools_check_mcp_health
      check: devtools_check_mcp_health
  # Thinking & Reasoning
  thinking:
    synonyms:
      - sequentialthinking
      - sequential-thinking
      - think
      - reason
    priority_server: sequential-thinking
    fallback_server: null

  # macOS-specific operations
  macos_use:
    priority_actions:
      - bash
      - zsh
      - sh
      - execute
      - run
      - cmd
      - command
      - git
      - npm
      - npx
      - pip
      - brew
      - curl
      - wget
      - time
      - clock
      - date
      - fetch
      - url
      - scrape
      - volume
      - brightness
      - mute
      - play
      - pause
      - calendar
      - event
      - reminder
      - note
      - mail
      - email
      - finder
      - trash
      - spotlight
      - applescript
      - osascript
    action_mapping:
      click: macos-use_click_and_traverse
      type: macos-use_type_and_traverse
      write: macos-use_type_and_traverse
      press: macos-use_press_key_and_traverse
      hotkey: macos-use_press_key_and_traverse
      refresh: macos-use_refresh_traversal
      screenshot: macos-use_take_screenshot
      vision: macos-use_analyze_screen
      ocr: macos-use_analyze_screen
      open: macos-use_open_application_and_traverse
      launch: macos-use_open_application_and_traverse
      scroll: macos-use_scroll_and_traverse
      fetch: macos-use_fetch_url
      fetch_url: macos-use_fetch_url
      time: macos-use_get_time
      get_time: macos-use_get_time
      notification: macos-use_send_notification
      run_applescript: macos-use_run_applescript
      applescript: macos-use_run_applescript
      spotlight: macos-use_spotlight_search
      spotlight_search: macos-use_spotlight_search
      clipboard_set: macos-use_set_clipboard
      set_clipboard: macos-use_set_clipboard
      clipboard_get: macos-use_get_clipboard
      get_clipboard: macos-use_get_clipboard
      right_click: macos-use_right_click_and_traverse
      double_click: macos-use_double_click_and_traverse
      drag: macos-use_drag_and_drop_and_traverse
      drop: macos-use_drag_and_drop_and_traverse
      drag_and_drop: macos-use_drag_and_drop_and_traverse

# =============================================================================
# TASK CLASSIFICATION
# =============================================================================
# Task type detection and recommended server selection
# Previously hardcoded in: mcp_registry.py (lines 216-298)
# =============================================================================

task_classification:
  gui_tasks:
    keywords: [gui, click, type, window, app, screen]
    recommended_servers: [macos-use]
    priority: tier1

  terminal_tasks:
    keywords: [terminal, command, shell, bash]
    recommended_servers: [macos-use]
    priority: tier1

  file_tasks:
    keywords: [file, read, write, directory]
    recommended_servers: [filesystem, macos-use]
    priority: tier1

  web_tasks:
    keywords: [search, web, internet, google, find, browser, navigate, automation, scrape]
    recommended_servers: [duckduckgo-search, puppeteer, macos-use]
    priority: tier2

  calendar_tasks:
    keywords: [calendar, event, meeting]
    recommended_servers: [macos-use]
    priority: tier2

  reminder_tasks:
    keywords: [reminder, todo, task]
    recommended_servers: [macos-use]
    priority: tier2

  note_tasks:
    keywords: [note, notes]
    recommended_servers: [macos-use]
    priority: tier2

  email_tasks:
    keywords: [mail, email]
    recommended_servers: [macos-use]
    priority: tier2

  git_tasks:
    keywords: [git, commit, push, pull, branch]
    recommended_servers: [macos-use]
    priority: tier2

  github_tasks:
    keywords: [github, repository, issue, pr]
    recommended_servers: [github, macos-use]
    priority: tier2

  voice_tasks:
    keywords: [voice, audio, transcribe, stt, speech]
    recommended_servers: [whisper-stt]
    priority: tier2

  debug_tasks:
    keywords: [debug, error, fix, analyze]
    recommended_servers: [vibe, sequential-thinking, redis]
    priority: tier2

  code_tasks:
    keywords: [code, review, refactor]
    recommended_servers: [vibe]
    priority: tier2

  thinking_tasks:
    keywords: [think, reason, complex, decision]
    recommended_servers: [sequential-thinking]
    priority: tier3

  time_tasks:
    keywords: [time, clock, date]
    recommended_servers: [macos-use]
    priority: tier2

  fetch_tasks:
    keywords: [fetch, url, http, download]
    recommended_servers: [macos-use]
    priority: tier2

  memory_tasks:
    keywords: [memory, recall, remember, fact, knowledge, observation]
    recommended_servers: [memory]
    priority: tier1

  graph_tasks:
    keywords: [graph, visualize, diagram, mermaid, map, relationship]
    recommended_servers: [graph, memory]
    priority: tier3

  state_tasks:
    keywords: [state, session, persistence, restart, recovery]
    recommended_servers: [redis]
    priority: tier3

  lint_tasks:
    keywords:
      [
        lint,
        ruff,
        oxlint,
        check_code,
        integrity,
        health,
        inspect_server,
        validate_config,
        knip,
        dead_code,
      ]
    recommended_servers: [devtools]
    priority: tier2

# =============================================================================
# STRATEGY SELECTION
# =============================================================================
# Dynamic strategy selection based on task type and context
# Previously hardcoded in: adaptive_behavior.py (get_strategy_recommendation)
# =============================================================================

strategy_selection:
  web_task:
    has_browser: puppeteer-first
    no_browser: macos-use-chrome
    default: macos-use-chrome

  file_task:
    allowed_path: filesystem-direct
    restricted_path: macos-use-finder
    default: filesystem-direct

  code_task:
    error_present: vibe-aggressive
    no_error: vibe-conservative
    default: vibe-conservative

  gui_task:
    complex_ui: vision-assisted
    simple_ui: accessibility-tree
    default: accessibility-tree

# =============================================================================
# ENGINE CONFIGURATION
# =============================================================================

engine:
  # Hot reload settings
  hot_reload_enabled: true
  config_watch_interval_seconds: 5

  # Performance optimization
  cache_enabled: true
  cache_ttl_seconds: 1800 # 30 minutes

  # Pattern matching
  pattern_confidence_threshold: 0.6
  max_pattern_evaluations_per_request: 10

  # Logging
  log_decisions: true
  log_level: INFO

# =============================================================================
# ADVANCED ORCHESTRATOR SETTINGS
# =============================================================================
# Deep customization of system behavior and decision-making logic

advanced:
  # ---------------------------------------------------------------------------
  # RECURSION AND DEPTH CONTROL
  # ---------------------------------------------------------------------------
  recursion:
    max_depth: 5                      # Maximum sub-task nesting levels
    max_iterations_per_level: 3       # Max retry attempts at each level
    depth_warning_threshold: 3        # Warn user when depth exceeds this
    
    # Auto-flatten: Prevent deep nesting by converting to sequential steps
    auto_flatten_enabled: true
    auto_flatten_depth: 4
  
  # ---------------------------------------------------------------------------
  # DEVIATION TOLERANCE
  # ---------------------------------------------------------------------------
  # Control how strictly system follows the planned strategy
  
  deviation:
    # Tolerance levels
    strict_mode: false                # If true, no deviation from plan allowed
    tolerance_level: moderate         # loose | moderate | strict
    
    # Deviation triggers
    allow_deviation_on:
      repeated_failures: true         # Allow after N failures
      failure_threshold: 2            # N failures before deviation
      
      low_confidence: true            # Allow when confidence < threshold
      confidence_threshold: 0.4
      
      explicit_user_request: true     # Always allow on user command
      
      stuck_detection: true           # Auto-deviate when stuck
      stuck_threshold_seconds: 120
    
    # Deviation strategies
    deviation_strategies:
      - name: adaptive_replanning      # Replan with Atlas
        priority: high
        trigger_on: [repeated_failures, stuck_detection]
        
      - name: vibe_escalation          # Escalate to Vibe for debugging
        priority: medium
        trigger_on: [repeated_failures, low_confidence]
        
      - name: simpler_approach         # Try simpler alternative
        priority: low
        trigger_on: [stuck_detection]
  
  # ---------------------------------------------------------------------------
  # VIBE ESCALATION POLICY
  # ---------------------------------------------------------------------------
  # When and how to escalate to Vibe for help
  
  vibe_escalation:
    enabled: true
    
    # Automatic escalation triggers
    auto_escalate_after_tetyana_failures: 3  # Escalate after N Tetyana failures
    auto_escalate_on_critical_error: true    # Immediate escalation on critical errors
    
    # Vibe Optimization Parameters
    vibe_auto_fix: true                      # Whether Vibe should automatically apply fixes
    vibe_quality_checks: true                # Run quality checks (lint/syntax) after Vibe changes
    vibe_max_iterations: 3                   # Max review/fix loops for complex tasks
    vibe_code_style: "ruff"                  # Preferred linter/style checker
    
    # Escalation types
    escalation_types:
      debugging:
        enabled: true
        trigger: error_analysis_needed
        vibe_tool: vibe_analyze_error
        
      code_review:
        enabled: true
        trigger: code_quality_concern
        vibe_tool: vibe_code_review
        
      architecture_help:
        enabled: true
        trigger: architectural_decision
        vibe_tool: vibe_smart_plan
    
    # Cooldown to prevent spam
    cooldown_seconds: 30
    max_escalations_per_session: 5

  
  # ---------------------------------------------------------------------------
  # RETRY AND RECOVERY POLICIES
  # ---------------------------------------------------------------------------
  
  retry:
    # Global retry settings
    max_retries_per_step: 3
    exponential_backoff: true
    backoff_multiplier: 2.0
    max_backoff_seconds: 60
    
    # Retry strategies by error type
    strategies:
      network_error:
        max_retries: 5
        backoff_seconds: 5
        
      permission_error:
        max_retries: 2
        escalate_to_sudo: true
        require_user_confirmation: true
        
      resource_unavailable:
        max_retries: 3
        wait_for_resource: true
        timeout_seconds: 30
        
      llm_rate_limit:
        max_retries: 10
        exponential_backoff: true
        backoff_base: 10
  
  # ---------------------------------------------------------------------------
  # TECHNICAL HELPERS
  # ---------------------------------------------------------------------------
  # Enhanced inference and fallback logic
  
  helpers:
    # Tool inference from arguments
    tool_inference:
      enabled: true
      confidence_threshold: 0.7
      
      # Inference rules (helper для _infer_tool_from_args)
      inference_patterns:
        vibe_keywords: [vibe, debug, analyze, review]
        gui_keywords: [click, type, press, screenshot, scroll]
        filesystem_keywords: [read, write, list, save, delete, file, path]
        browser_keywords: [browser, puppeteer, navigate, google, search, web]
        terminal_keywords: [command, cmd, execute, run, shell]
    
    # Intent fallback classification
    intent_fallback:
      enabled: true
      fallback_to_chat_on_uncertainty: true
      uncertainty_threshold: 0.5
      
    # Model selection helpers
    model_selection:
      auto_select_vision_model: true    # Auto-switch to vision model when image present
      auto_select_code_model: true      # Use code_analysis model for code tasks
      prefer_fast_models_for_simple: true # Use fallback for simple tasks
  
  # ---------------------------------------------------------------------------
  # STRATEGY SEQUENCE SETTINGS
  # ---------------------------------------------------------------------------
  # Advanced control over multi-agent strategy execution
  
  strategy:
    # Planning phase
    planning:
      require_atlas_approval: false   # Require user approval of plan
      min_plan_quality_score: 0.6     # Minimum quality to proceed
      replan_on_low_quality: true     # Auto-replan if quality low
      
    # Execution phase
    execution:
      parallel_execution: false       # Execute steps in parallel (experimental)
      max_parallel_steps: 2
      
      # Step timeout management
      step_timeout_strategy: adaptive # fixed | adaptive
      base_step_timeout: 120          # Base timeout in seconds
      timeout_multiplier_on_retry: 1.5
      
    # Verification phase
    verification:
      require_grisha_audit: false     # Require Grisha verification
      audit_frequency: on_failure     # always | on_failure | never
      quality_threshold: 0.7          # Minimum quality to pass
  
  # ---------------------------------------------------------------------------
  # MEMORY AND LEARNING
  # ---------------------------------------------------------------------------
  
  learning:
    # Automatic pattern learning
    auto_learn_patterns: true
    min_pattern_occurrences: 3        # Learn pattern after N occurrences
    pattern_confidence_boost: 0.1     # Confidence increase per success
    
    # Memory persistence
    remember_successful_strategies: true
    remember_failed_strategies: true
    consolidation_frequency: nightly  # nightly | weekly | disabled
    
    # Context retention
    max_conversation_context: 25      # Messages to keep in context
    compress_old_context: true        # Compress context after N messages
    compression_threshold: 50

# =============================================================================
# MODEL-SPECIFIC OVERRIDES
# =============================================================================
# Fine-tune model behavior for specific scenarios

model_overrides:
  # Use different models for specific task types
  task_specific:
    vision_tasks:
      preferred_model: vision        # From models.vision in config.yaml
      fallback_model: default
      
    code_tasks:
      preferred_model: code_analysis
      fallback_model: vibe_default   # Route to Vibe binary
      
    deep_reasoning:
      preferred_model: reasoning
      enable_sequential_thinking: true
      
    simple_chat:
      preferred_model: fallback      # Use faster model for chat
      skip_planning: true

# =============================================================================
# WORKFLOW STAGES CONFIGURATION
# =============================================================================
# Define all execution stages and their behavior parameters

workflow_stages:
  # ---------------------------------------------------------------------------
  # CHAT STAGE
  # ---------------------------------------------------------------------------
  # Simple conversational responses without task execution
  
  chat:
    enabled: true
    description: "Simple conversational chat with Atlas"
    
    # Behavior settings
    use_deep_persona: false          # Use philosophical/deep personality
    require_tools: false             # No MCP tools needed
    skip_planning: true              # No Tetyana/Grisha involved
    skip_memory_save: false          # Still save conversation context
    
    # Triggers (when to use this stage)
    triggers:
      max_words: 6                   # Short requests (< 6 words)
      keywords_present: true         # Matches greeting keywords
      no_action_verbs: true          # No task verbs detected
      
    # Model selection
    preferred_model: fallback        # Use faster model for chat
    
  # ---------------------------------------------------------------------------
  # DEEP CHAT STAGE
  # ---------------------------------------------------------------------------
  # Philosophical/identity conversations with full personality
  
  deep_chat:
    enabled: true
    description: "Deep personality-driven conversations"
    
    # Behavior settings
    use_deep_persona: true           # CRITICAL: Full philosophical mode
    require_tools: false
    skip_planning: true
    include_system_history: true     # Include our shared history
    
    # Triggers
    triggers:
      identity_topics: true          # Questions about Atlas identity
      philosophical_keywords: 
        - "хто ти"
        - "душа"
        - "призначення"
        - "філософія"
        - "who are you"
        - "your purpose"
        - "your soul"
      emotional_topics: true         # Heart-to-heart discussions
      
    # Model selection
    preferred_model: default         # Use full model for depth
    
  # ---------------------------------------------------------------------------
  # SOLO TASK STAGE
  # ---------------------------------------------------------------------------
  # Atlas handles independently with tools (no Tetyana/Grisha)
  
  solo_task:
    enabled: true
    description: "Information tasks Atlas can handle solo"
    
    # Behavior settings
    use_deep_persona: false
    require_tools: true              # Atlas needs tools (search, filesystem)
    skip_planning: true              # No multi-agent planning
    max_execution_time: 30           # Seconds
    
    # Triggers
    triggers:
      info_query_detected: true      # From intent_detection.info_query
      has_required_tools: true       # Atlas has necessary tools
      no_system_changes: true        # No file creation/system control
      
    # Allowed tools for solo tasks
    allowed_tools:
      - search
      - duckduckgo_search
      - read_file
      - list_files
      - memory_search
      - get_time
      - fetch_url
      
    # Model selection
    preferred_model: default
    
  # ---------------------------------------------------------------------------
  # RECALL STAGE
  # ---------------------------------------------------------------------------
  # Memory retrieval from past conversations
  
  recall:
    enabled: true
    description: "Retrieve information from memory/history"
    
    # Behavior settings
    use_deep_persona: false
    require_tools: true              # Need memory tools
    skip_planning: true
    
    # Memory search settings
    memory_search:
      max_results: 5
      min_relevance_score: 0.6
      include_entities: true
      include_conversations: true
      include_strategies: true
      
    # Model selection
    preferred_model: default
    
  # ---------------------------------------------------------------------------
  # STATUS STAGE
  # ---------------------------------------------------------------------------
  # System status and health checks
  
  status:
    enabled: true
    description: "Report system status and metrics"
    
    # Behavior settings
    use_deep_persona: false
    require_tools: true              # Health check tools
    skip_planning: true
    
    # Status components
    report_components:
      - mcp_servers_status
      - active_sessions
      - memory_stats
      - recent_tasks
      - system_metrics
      
    # Model selection
    preferred_model: fallback        # Fast model sufficient
    
  # ---------------------------------------------------------------------------
  # TASK STAGE
  # ---------------------------------------------------------------------------
  # Full multi-agent execution (Atlas → Tetyana → Grisha)
  
  task:
    enabled: true
    description: "Complex tasks requiring planning and execution"
    
    # Behavior settings
    use_deep_persona: true           # Full context for planning
    require_planning: true           # Atlas creates plan
    require_execution: true          # Tetyana executes
    require_verification: false      # Grisha audit (configurable)
    
    # Planning phase
    planning:
      min_steps: 1                   # Minimum plan complexity
      max_steps: 20                  # Maximum steps allowed
      require_approval: false        # User approval needed
      quality_threshold: 0.6
      
    # Execution phase  
    execution:
      allow_recursion: true
      max_recursion_depth: 5         # From advanced.recursion
      adaptive_timeout: true
      base_timeout: 120
      
    # Verification phase
    verification:
      enabled: false                 # Set to true to enable Grisha
      on_failure_only: true
      quality_threshold: 0.7
      
    # Model selection (cascading from task type)
    model_selection:
      planning: default
      execution: default
      verification: default
      
  # ---------------------------------------------------------------------------
  # DEVELOPMENT STAGE
  # ---------------------------------------------------------------------------
  # Software development tasks with Vibe escalation
  
  development:
    enabled: true
    description: "Code development with Vibe assistance"
    
    # Inherits from task stage
    extends: task
    
    # Override settings
    execution:
      prefer_vibe_for_code: true     # Escalate code tasks to Vibe
      vibe_escalation_threshold: 2   # After 2 Tetyana failures
      
    verification:
      enabled: true                  # Always verify code quality
      require_lint_pass: true
      require_tests_pass: false
      
    # Model selection
    model_selection:
      planning: default
      execution: code_analysis
      verification: default
      code_review: vibe_default       # Use Vibe for code review

# =============================================================================
# PATH CONFIGURATION
# =============================================================================
# Centralized path management for all system components

paths:
  # Base directories
  config_root: ${CONFIG_ROOT}        # Usually ~/.config/atlastrinity
  project_root: ${PROJECT_ROOT}      # Project repository root
  home: ${HOME}                      # User home directory
  
  # Application directories
  logs: ${CONFIG_ROOT}/logs
  memory: ${CONFIG_ROOT}/memory
  screenshots: ${CONFIG_ROOT}/screenshots
  workspace: ${CONFIG_ROOT}/workspace
  vibe_workspace: ${CONFIG_ROOT}/vibe_workspace
  
  # Model directories
  models:
    tts: ${CONFIG_ROOT}/models/tts
    stt: ${CONFIG_ROOT}/models/faster-whisper
    
  # MCP directories
  mcp:
    config: ${CONFIG_ROOT}/mcp
    servers: ${PROJECT_ROOT}/vendor
    
  # Database paths
  database:
    sqlite: ${CONFIG_ROOT}/atlastrinity.db
    chroma: ${CONFIG_ROOT}/memory/chroma
    
  # Temporary and cache
  temp: /tmp/atlastrinity
  cache: ${CONFIG_ROOT}/cache
  
  # Backup directories
  backups:
    databases: ${PROJECT_ROOT}/backups/databases
    configs: ${PROJECT_ROOT}/backups/configs

# =============================================================================
# BEHAVIORAL PERSONA CONFIGURATION
# =============================================================================
# Define personality traits and response patterns

behavioral_persona:
  # Atlas personality modes
  atlas:
    # Standard mode
    standard:
      tone: professional_friendly
      verbosity: concise
      language: ukrainian
      formality: informal
      
    # Deep persona mode (philosophical)
    deep:
      tone: philosophical_warm
      verbosity: expressive
      include_metaphors: true
      include_history: true
      emotional_intelligence: high
      
  # Tetyana personality  
  tetyana:
    tone: efficient_focused
    verbosity: minimal
    report_style: technical
    
  # Grisha personality
  grisha:
    tone: analytical_precise
    verbosity: detailed
    report_style: audit_report

# =============================================================================
# RESPONSE TEMPLATES
# =============================================================================
# Standardized response patterns for consistency

response_templates:
  # Success messages
  success:
    task_completed: "Завдання успішно виконано."
    plan_created: "План створено ({steps} кроків)."
    verification_passed: "Верифікація пройдена успішно."
    
  # Error messages
  errors:
    no_steps: "Не вдалося створити план виконання."
    planning_failed: "Помилка при плануванні завдання."
    execution_failed: "Помилка при виконанні кроку {step}."
    
  # Status messages
  status:
    analyzing: "Аналізую ваш запит..."
    planning: "Створюю план дій..."
    executing: "Виконую крок {current}/{total}..."
    verifying: "Перевіряю результат..."

# =============================================================================
# SELF-HEALING CONFIGURATION
# =============================================================================
# Advanced self-repair and recovery mechanisms

self_healing:
  # ---------------------------------------------------------------------------
  # AUTOMATIC ERROR RECOVERY
  # ---------------------------------------------------------------------------
  enabled: true
  
  # Recovery strategies priority order
  recovery_strategies:
    - name: retry_with_backoff
      priority: 1
      enabled: true
      max_attempts: 3
      applicable_errors: [network, timeout, temporary]
      
    - name: alternative_tool
      priority: 2
      enabled: true
      try_alternative_server: true
      try_alternative_tool: true
      
    - name: simplify_approach
      priority: 3
      enabled: true
      break_into_smaller_steps: true
      reduce_complexity: true
      
    - name: vibe_consultation
      priority: 4
      enabled: true
      escalate_to_vibe: true
      vibe_tool: vibe_analyze_error
      min_failure_count: 2
      
    - name: atlas_replanning
      priority: 5
      enabled: true
      request_new_plan: true
      include_error_context: true
      
    - name: user_intervention
      priority: 6
      enabled: true
      ask_user_for_help: true
      provide_error_details: true
  
  # ---------------------------------------------------------------------------
  # ERROR ANALYSIS AND DIAGNOSIS
  # ---------------------------------------------------------------------------
  error_analysis:
    enabled: true
    
    # Automatic classification
    classify_errors: true
    error_categories:
      - network_errors        # Connection, timeout
      - permission_errors     # Access denied, sudo needed
      - resource_errors       # File not found, disk full
      - logic_errors          # Wrong approach, invalid state
      - llm_errors           # Rate limit, token overflow
      - tool_errors          # Tool not available, server down
      
    # Root cause analysis
    deep_analysis:
      enabled: true
      use_vibe_for_complex: true
      complexity_threshold: 3      # Use Vibe after 3 failures
      
    # Pattern recognition
    learn_from_errors:
      enabled: true
      store_error_patterns: true
      suggest_prevention: true
  
  # ---------------------------------------------------------------------------
  # PROACTIVE HEALTH MONITORING
  # ---------------------------------------------------------------------------
  health_monitoring:
    enabled: true
    
    # Pre-execution validation
    pre_checks:
      validate_tools_available: true
      check_server_health: true
      verify_permissions: true
      estimate_success_probability: true
      
    # During execution monitoring
    live_monitoring:
      track_step_duration: true
      detect_infinite_loops: true
      monitor_resource_usage: true
      early_failure_detection: true
      
    # Post-execution validation
    post_checks:
      verify_expected_outcome: true
      check_side_effects: true
      validate_data_integrity: true
  
  # ---------------------------------------------------------------------------
  # RECOVERY PERSISTENCE
  # ---------------------------------------------------------------------------
  persistence:
    save_recovery_attempts: true
    database_table: recovery_attempts
    
    # Analytics
    track_success_rate: true
    identify_problematic_tools: true
    recommend_preventive_actions: true

# =============================================================================
# SOFTWARE DEVELOPMENT WORKFLOW
# =============================================================================
# Specialized configuration for code creation and modification

software_development:
  # ---------------------------------------------------------------------------
  # CODE GENERATION SETTINGS
  # ---------------------------------------------------------------------------
  code_generation:
    enabled: true
    
    # Quality standards
    quality:
      require_type_hints: true
      require_docstrings: true
      require_error_handling: true
      max_function_length: 50        # Lines
      max_complexity: 10             # Cyclomatic complexity
      
    # Code style
    style:
      formatter: ruff                # ruff | black
      linter: ruff                   # ruff | pylint
      auto_format: true
      auto_fix_lint: true
      
    # Testing requirements
    testing:
      require_tests: false           # Require tests for new code
      test_framework: pytest         # pytest | unittest
      min_coverage: 80               # Percentage
      
  # ---------------------------------------------------------------------------
  # CODE MODIFICATION WORKFLOW
  # ---------------------------------------------------------------------------
  code_modification:
    enabled: true
    
    # Safety checks
    safety:
      require_backup: true
      git_commit_before: true
      validate_syntax_before: true
      run_tests_after: true
      
    # Modification strategies
    strategies:
      - name: minimal_change
        priority: high
        description: "Make smallest possible change"
        
      - name: refactor_first
        priority: medium
        description: "Refactor before adding features"
        
      - name: test_driven
        priority: medium
        description: "Write tests first, then implement"
        
  # ---------------------------------------------------------------------------
  # CODE REVIEW PROCESS
  # ---------------------------------------------------------------------------
  code_review:
    enabled: true
    
    # Automatic review
    auto_review:
      enabled: true
      use_vibe: true
      vibe_tool: vibe_code_review
      
      # Review criteria
      check_security: true
      check_performance: true
      check_readability: true
      check_best_practices: true
      
    # Review depth
    depth:
      quick_scan: false              # Just lint and format
      standard_review: true          # Security, performance
      deep_audit: false              # Architecture, design patterns
      
    # Grisha verification
    grisha_verification:
      enabled: false                 # Require Grisha audit
      on_critical_changes: true      # Only for critical code
      quality_threshold: 0.8
      
  # ---------------------------------------------------------------------------
  # DEBUGGING WORKFLOW
  # ---------------------------------------------------------------------------
  debugging:
    enabled: true
    
    # Debug strategies
    strategies:
      - name: reproduce_error
        priority: 1
        enabled: true
        
      - name: analyze_logs
        priority: 2
        enabled: true
        use_vibe: true
        
      - name: isolate_cause
        priority: 3
        enabled: true
        create_minimal_example: true
        
      - name: fix_and_verify
        priority: 4
        enabled: true
        run_tests_after_fix: true
        
    # Vibe integration
    vibe_debugging:
      enabled: true
      auto_escalate_on_complex: true
      complexity_indicators:
        - multiple_failure_attempts
        - unfamiliar_error_message
        - cross_system_issue
        
  # ---------------------------------------------------------------------------
  # ARCHITECTURE DECISIONS
  # ---------------------------------------------------------------------------
  architecture:
    enabled: true
    
    # Decision-making
    decisions:
      consult_vibe_for_design: true
      vibe_tool: vibe_smart_plan
      
      # When to consult
      consult_triggers:
        - new_component
        - major_refactoring
        - performance_critical
        - security_sensitive
        
    # Design patterns
    patterns:
      suggest_patterns: true
      prefer_simple: true
      avoid_over_engineering: true
      
  # ---------------------------------------------------------------------------
  # DEPENDENCY MANAGEMENT
  # ---------------------------------------------------------------------------
  dependencies:
    # Installation
    auto_install: false              # Manual approval required
    use_venv: true
    prefer_pinned_versions: true
    
    # Version control
    version_strategy: conservative   # conservative | latest | specific
    
    # Security
    check_vulnerabilities: true
    block_known_vulnerabilities: true
    
  # ---------------------------------------------------------------------------
  # DOCUMENTATION GENERATION
  # ---------------------------------------------------------------------------
  documentation:
    enabled: true
    
    # Auto-generate
    auto_generate:
      docstrings: true
      readme: true
      api_docs: false
      
    # Documentation style
    style:
      format: google                 # google | numpy | sphinx
      language: english              # english | ukrainian
      detail_level: standard         # minimal | standard | comprehensive

# =============================================================================
# WORKFLOW AUTOMATION
# =============================================================================
# Deterministic finite state machine definitions for system processes
# Replaces hardcoded sequences in orchestrator.py

# ---------------------------------------------------------------------------
# WORKFLOWS (Finite State Machines)
# ---------------------------------------------------------------------------
workflows:
  # ---------------------------------------------------------------------------
  # SYSTEM STARTUP
  # ---------------------------------------------------------------------------
  startup:
    description: "System initialization sequence"
    on_error: "continue"              # abort | continue | retry
    
    stages:
      - name: "init_services"
        steps:
          - action: "internal.log"
            params: { msg: "AtlasTrinity Brain is waking up...", level: "info" }
            
          - action: "internal.check_services"
            params: { timeout: 60 }
            
          - action: "internal.state_init"
            params: { reset: false }
            
      - name: "load_memory"
        steps: 
          - action: "internal.db_init"
            
          - action: "internal.memory_warmup"
            params: { async_warmup: true }
            
      - name: "final_check"
        steps:
          - action: "internal.log"
            params: { msg: "System initialization complete. Waiting for input.", level: "info" }

  # ---------------------------------------------------------------------------
  # ERROR RECOVERY
  # ---------------------------------------------------------------------------
  error_recovery:
    description: "Autonomous self-healing protocol"
    
    stages:
      - name: "diagnose"
        steps:
          - action: "internal.log"
            params: { msg: "Initiating self-healing protocols...", level: "warning" }
          - action: "internal.check_services"
            params: { timeout: 30 }
          - action: "internal.analyze_error"
            id: "error_analysis"
            
      - name: "attempt_fix"
        steps:
          - if: "${error_analysis.can_auto_fix}"
            then:
              action: "internal.apply_fix"
              params: { fix_id: "${error_analysis.fix_id}" }
            else:
              action: "internal.escalate"
              params: { target: "user" }


# ---------------------------------------------------------------------------
# ORCHESTRATION FLOW (LangGraph Structure)
# ---------------------------------------------------------------------------
orchestration_flow:
  entry_point: "atlas_planning"
  nodes:
    - name: "atlas_planning"
      type: "planner"
      next: "tetyana_execution"
    - name: "tetyana_execution"
      type: "executor"
      conditional_edge:
        evaluator: "should_verify"
        mapping:
          verify: "grisha_verification"
          continue: "tetyana_execution"
          end: "__end__"
    - name: "grisha_verification"
      type: "verifier"
      next: "tetyana_execution"

  rules:
    should_verify:
      - condition: "has_error"
        result: "continue"   # Retry execution
      - condition: "task_completed"
        result: "end"
      - condition: "needs_verification"
        result: "verify"
      - default: "continue"

# ---------------------------------------------------------------------------
# BACKGROUND MONITORING
# ---------------------------------------------------------------------------
background_monitoring:
  mcp_health:
    interval: 60
    auto_restart: true
    max_retries: 5
    backoff_base: 0.5
  
  memory_consolidation:
    enabled: true
    interval: 3600  # 1 hour

# ---------------------------------------------------------------------------
# OUTPUT PROCESSING
# ---------------------------------------------------------------------------
output_processing:
  voice:
    sanitization_rules:
      - pattern: "\\s+"
        replacement: " "
      - pattern: "[`*#_]"
        replacement: "" # Strip markdown
    min_length: 2
    max_length: 5000

# ---------------------------------------------------------------------------
# TOOL ROUTING FALLBACKS
# ---------------------------------------------------------------------------
tool_routing_fallbacks:
  fetch: "macos-use_fetch_url"
  fetch_url: "macos-use_fetch_url"
  get_time: "macos-use_get_time"
  screenshot: "macos-use_take_screenshot"
  terminal: "execute_command"
  search: "macos-use_spotlight_search"
  notification: "macos-use_send_notification"
  finder_list: "macos-use_finder_list_files"
  sequentialthinking: "sequential-thinking_sequentialthinking"

